(function(){this.$loadTpls=function(h,a){var b=document.createElement("div"),c=h.length;h.forEach(function(d,f){var e=document.createElement("div");e.setAttribute("id","tpl-"+f);b.appendChild(e);$(e).load(d+"?v="+v,function(){c--;0==c&&a()})});document.body.appendChild(b)};var k={};this.$tpl=function a(b,c){var d;/\W/.test(b)?d=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,
"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):((d=k[b])||((elem=document.getElementById(b))?d=elem.innerHTML:(console.error("Template #"+b+" not found"),d="no template"),d=a(d)),d=k[b]=d);return c?d(c):d};this.$get=function(a,b,c,d){var f={},e=localStorage.getItem("auth");e&&(f["X-Auth"]=e);$.ajax({type:"GET",url:a,contentType:"application/json",headers:f,success:function(a){"object"===typeof a?b(a):b(JSON.parse(a))},
error:function(a,b,e){401!==a.status||d||(window.location=AUTH_LOGIN_PATH,localStorage.removeItem("auth"));c?c(e):console.error("error on "+a.responseURL+" status="+a.status)}})};this.$post=function(a,b,c,d,f){var e={},g=localStorage.getItem("auth");g&&(e["X-Auth"]=g);$.ajax({type:"POST",url:a,data:JSON.stringify(b),contentType:"application/json",headers:e,success:function(a){"object"===typeof a?c(a):c(JSON.parse(a))},error:function(a,b,c){401!==a.status||f||(window.location=AUTH_LOGIN_PATH,localStorage.removeItem("auth"));
d?d(c):console.error("error on "+a.responseURL+" status="+a.status)}})};this.$sync=function(a,b){"undefined"!=typeof actions&&(b=actions[a]);(url=!b||b&&!b.url?"/"+a:b.url)?$get(url,function(c){b&&b.transform&&(c=eval(b.transform)(c));$(".ui-"+a).html($tpl("tpl_"+a,c));b&&b.onSuccess&&eval(b.onSuccess)()}):console.error("url not defined in obj:",b)};this.$call=function(a){if(null==a){for(first in actions)break;a=first}for(var b in actions)b==a?$(".ui-action-"+b).addClass("active"):($(".ui-"+b).html(""),
$(".ui-action-"+b).removeClass("active"));args="";r=$param("r");null!=r&&(args="&r="+r);window.history.pushState(a,a,"?p="+a+args);obj=actions[a];obj.loading&&$(".ui-"+a).html($tpl("tpl_loading"));$sync(a)};this.$bind=function(a){for(var b in a)$(".action-"+b).on("click",function(){action=$(this).attr("class").replace(/.*action-/,"").replace(" active","");$call(action)});r=$param("r");null!=r&&null!=r&&setInterval(function(){$call($param("p"))},1E3*r)};this.$initActions=function(){actions&&($bind(actions),
$call($param("p")))};this.$param=function(a){var b=window.location.href;a=a.replace(/[\[\]]/g,"\\$&");return(a=(new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)")).exec(b))?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null};this.$roundNumeral=function(a){return isNaN(a)?a:numeral(a).format("0 0.00 a")};this.$round=function(a){return isNaN(a)?a:Number(a.toFixed(2))};this.$fromNow=function(a){return moment.unix(a).add(0,"hours").fromNow()};this.$lsSet=function(a,b){if(Array.isArray(b)||"object"===typeof b)b=
JSON.stringify(b);localStorage.setItem(a,b)};this.$lsGet=function(a){(value=localStorage.getItem(a))&&"{"===value[0]&&(value=JSON.parse(value));return value};this.$lsRm=function(a){localStorage.removeItem(a)};this.$scrollToBottom=function(a,b){function c(){var a=Math.min(1,(Date.now()-g)/b);d.scrollTop=e*a+f;1>a&&setTimeout(c,10)}var d=a[0],f=d.scrollTop,e=d.scrollHeight-a.height()-f,g=Date.now();c()};this.$setElementHeight=function(a,b){$(a).height($(window).height()-b)};var h=0;this.$ws=function b(c,
d,f,e){-1==c.indexOf("s://")&&(wsProto="ws:","https:"==window.location.protocol&&(wsProto="wss:"),c=wsProto+"//"+window.location.host+c);ws=new WebSocket(c);ws.onopen=function(){h=1;d(c,d)};ws.onmessage=function(b){e(b)};ws.onclose=function(g){g=1E3*Math.min(15,Math.pow(2,h)-1);f(g);setTimeout(function(){h++;ws=b(c,d,f,e)},g)};return ws}})();
