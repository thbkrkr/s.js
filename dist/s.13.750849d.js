(function(){this.$loadTpls=function(g,a){var b=document.createElement("div"),d=g.length;g.forEach(function(c,e){var f=document.createElement("div");f.setAttribute("id","tpl-"+e);b.appendChild(f);$(f).load(c+"?v="+v,function(){d--;0==d&&a()})});document.body.appendChild(b)};var h={};this.$tpl=function a(b,d){var c;/\W/.test(b)?c=new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,
"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):((c=h[b])||((elem=document.getElementById(b))?c=elem.innerHTML:(console.error("Template #"+b+" not found"),c="no template"),c=a(c)),c=h[b]=c);return d?c(d):c};this.$get=function(a,b,d,c){var e={},f=localStorage.getItem("auth");f&&(e["X-Auth"]=f);$.ajax({type:"GET",url:a,contentType:"application/json",headers:e,success:function(a){"object"===typeof a?b(a):b(JSON.parse(a))},
error:function(a,b,e){401!==a.status||c||(window.location=AUTH_LOGIN_PATH,localStorage.removeItem("auth"));d?d(e):console.error("error on "+a.responseURL+" status="+a.status)}})};this.$post=function(a,b,d,c,e){var f={},g=localStorage.getItem("auth");g&&(f["X-Auth"]=g);$.ajax({type:"POST",url:a,data:JSON.stringify(b),contentType:"application/json",headers:f,success:function(a){"object"===typeof a?d(a):d(JSON.parse(a))},error:function(a,b,d){401!==a.status||e||(window.location=AUTH_LOGIN_PATH,localStorage.removeItem("auth"));
c?c(d):console.error("error on "+a.responseURL+" status="+a.status)}})};this.$loadTpl=function(a){obj=actions[a];$get(obj.url,function(b){obj.transform&&(b=eval(obj.transform)(b));$(".tpl."+a).html($tpl("tpl_"+a,b));obj.onSuccess&&eval(obj.onSuccess)()})};this.$call=function(a){if(null==a){for(first in actions)break;a=first}obj=actions[a];for(var b in actions)b==a?$(".action-"+b).addClass("active"):($(".tpl."+b).html(""),$(".action-"+b).removeClass("active"));args="";r=$param("r");null!=r&&(args=
"&r="+r);window.history.pushState(a,a,"?p="+a+args);obj.loading&&$(".tpl."+a).html($tpl("tpl_loading"));$loadTpl(a)};this.$bind=function(a){for(var b in a)$(".action-"+b).on("click",function(){action=$(this).attr("class").replace(/.*action-/,"").replace(" active","");$call(action)});r=$param("r");null!=r&&null!=r&&setInterval(function(){$call($param("p"))},1E3*r)};this.$initActions=function(){actions&&($bind(actions),$call($param("p")))};this.$param=function(a){var b=window.location.href;a=a.replace(/[\[\]]/g,
"\\$&");return(a=(new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)")).exec(b))?a[2]?decodeURIComponent(a[2].replace(/\+/g," ")):"":null};this.$roundNumeral=function(a){return isNaN(a)?a:numeral(a).format("0 0.00 a")};this.$round=function(a){return isNaN(a)?a:Number(a.toFixed(2))};this.$fromNow=function(a){return moment.unix(a).add(0,"hours").fromNow()};this.$lsSet=function(a,b){if(Array.isArray(b)||"object"===typeof b)b=JSON.stringify(b);localStorage.setItem(a,b)};this.$lsGet=function(a){(value=localStorage.getItem(a))&&
"{"===value[0]&&(value=JSON.parse(value));return value};this.$lsRm=function(a){localStorage.removeItem(a)};this.$scrollToBottom=function(a,b){function d(){var a=Math.min(1,(Date.now()-g)/b);c.scrollTop=f*a+e;1>a&&setTimeout(d,10)}var c=a[0],e=c.scrollTop,f=c.scrollHeight-a.height()-e,g=Date.now();d()};this.$setElementHeight=function(a,b){$(a).height($(window).height()-b)};var g=0;this.$ws=function(a,b,d,c){-1!=a.indexOf("s://")?url=a:(wsProto="ws:","https:"==window.location.protocol&&(wsProto="wss:"),
url=wsProto+"//"+window.location.host+a);ws=new WebSocket(url);ws.onopen=function(){g=1;b(a,b)};ws.onmessage=function(a){c(a)};ws.onclose=function(e){e=1E3*Math.min(15,Math.pow(2,g)-1);d(e);setTimeout(function(){g++;ws=$ws(a,b,d,c)},e)};return ws}})();
